<!DOCTYPE HTML>

<html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TERA</title>
    <link rel="shortcut icon" href="/HTML/PIC/wallet.png" type="image/png">

    <link rel="stylesheet" type="text/css" href="../HTML/CSS/style.css">
    <link rel="stylesheet" type="text/css" href="../HTML/CSS/wallet.css">
    <link rel="stylesheet" type="text/css" href="../HTML/CSS/buttons.css">

</head>



<script>
    window.RUN_CLIENT=1;
    window.RUN_SERVER=0;
    if(typeof global === 'object')
    {
        global.RUN_CLIENT=1;
        global.RUN_SERVER=0;
    }
</script>

<script type="text/javascript" src="/HTML/JS/coinlib.js"></script>
<script type="text/javascript" src="../HTML/JS/client.js"></script>
<script type="text/javascript" src="../HTML/JS/sha3.js"></script>
<script type="text/javascript" src="../HTML/JS/crypto-client.js"></script>




<script>
    var PayList=[];
    var AttachItem;

    var CONFIG_DATA={}; CONFIG_DATA.CONSTANTS={};
    var ServerBlockNumDB=0;
    var ServerCurBlockNum=0;
    var ServerTime=0;
    var CanSendTransaction=1;
    var MiningAccount=0;
    var min_power_pow_acc_create=0;
    var WalletStatus;
    var BLOCK_PROCESSING_LENGTH=8;
    var PubKeyStr;
    var PrivKeyStr;
    var WalletOpen;
    var MapAccounts={};
    var MapCheckTransaction={};
    //var MapSendTransaction={};


    var INTERNET_IP_FROM_STUN;
    var SERVER_IP;
    var SERVER_PORT;

    var CurTabName;

    var TabArr=[{name:"TabAccounts",log:1},{name:"TabSend",log:1},{name:"TabHistory"},{name:"TabDapps"},{name:"TabExplorer"}];
    var SaveIdArr=["idAccount","idTo","idSumSend","idDescription","idSelStyle",
        "idViewAccountNum","idViewBlockNum","idViewHistoryNum","idViewActNum","idViewHashNum","idViewDappNum",
        "idRunText","idViewAccountFilter","idViewHistoryFilter","idUseSoundHistory",
        "idBlockCount","idPeriodAutoCheckPoint"];
    var LoadMapAfter={};


    var MaxAccID=0;
    var MaxDappsID=0;
    var MaxActNum=0;
    var HistoryMaxNum=0;
    var MaxBlockNum=0;

    var idPercentItem;

    var CurrentTR={};
    var WasSetRestart=0;

</script>

<script>
    /*User action User action User action User action User action User action User action User action User action */

    //CONFIG
    //CONFIG
    //CONFIG
    function IsPrivateMode()
    {
        if(PrivKeyStr && PrivKeyStr.length===64)
            return true;
        else
            return false;
    }

    function MiningSets()
    {
        var name="edit_mining_set";
        if(IsVisibleBlock(name))
        {
            SetVisibleBlock(name,false);
        }
        else
        {
            SetVisibleBlock(name,true);
            document.getElementById("idMiningAccount").value=MiningAccount;
            document.getElementById("idMiningAccount").focus();
        }
    }
    function SaveMiningSet(Value)
    {
        SetVisibleBlock("edit_mining_set",false)

        if(Value)
        {
            MiningAccount=Value;
        }
        else
        {
            MiningAccount=ParseNum(document.getElementById("idMiningAccount").value);
        }
        GetData("SetMining",MiningAccount,function (Data)
        {

        });


    }
    function CancalMiningSet()
    {
        var name="edit_mining_set";
        SetVisibleBlock(name,false)
    }



    function NewPrivateKey()
    {
        var arr = new Uint8Array(32);
        window.crypto.getRandomValues(arr);
        var Str=GetHexFromArr(arr);

        document.getElementById("idKeyNew").value=Str;
        SetVisibleEditKeys(1);

        var Select=document.getElementById("idTypeKey");
        Select.value="private";

        SetVisibleItemByTypeKey();
    }
    function EditPrivateKey()
    {
        if(!IsVisibleBlock("edit_keys"))
        {
            var Select=document.getElementById("idTypeKey");
            if(IsPrivateMode())
            {
                document.getElementById("idKeyNew").value=PrivKeyStr;
                Select.value="private";
            }
            else
            {
                document.getElementById("idKeyNew").value=PubKeyStr;
                Select.value="public";
            }



            SetVisibleEditKeys(1);
        }
        else
        {
            CancelSavePrivateKey();
        }
    }

    function ConvertToPrivateKey()
    {
        var Str=document.getElementById("idKeyNew").value;
        if(!Str || Str.length<20)
        {
            SetError("Enter secret words that are at least 20 characters long");
            return;
        }

        var Str2=document.getElementById("idKeyNew2").value;
        if(Str2 && Str!==Str2)
        {
            SetError("Re-entered secret does not match");
            return;
        }

        document.getElementById("idTypeKey").value="private";
        SetVisibleItemByTypeKey();
        document.getElementById("idKeyNew").value=GetPrivateKeyFromStr(Str);
        document.getElementById("idKeyNew2").value="";
    }

    function GetPrivateKeyFromStr(Str)
    {
        var StrHex=sha3_str(Str);
        for(var i=0;i<100000;i++)
            StrHex=sha3_str(StrHex);

        return StrHex.toUpperCase();
    }

    function SavePrivateKey()
    {
        var Select=document.getElementById("idTypeKey");
        if(Select.value==="brain")
        {
            ConvertToPrivateKey();
            return;
        }

        var Str=document.getElementById("idKeyNew").value;
        Str=Str.trim();
        if(Select.value==="private" && (Str.length!==64 || !IsHexStr(Str)))
        {
            SetError("Error: Length must 64 HEX chars. (Length="+Str.length+")");
            return;
        }
        else
        if(Select.value!=="private" && (Str.length!==66 || Str.substr(0,1)!=="0" || !IsHexStr(Str)))
        {
            SetError("Error: Length must 66 HEX chars. (Length="+Str.length+")");
            return;
        }

        if(Select.value==="private" && PrivKeyStr!==Str)
            SetStatus("Changed privat key");
        else
        if(Select.value==="public" && PubKeyStr!==Str)
            SetStatus("Changed public key");

        GetData("SetWalletKey",Str, function (Data)
        {
            if(Data && Data.result===1)
            {
                if(Select.value==="private")
                    SelectStyle("styleBlue");
                else
                if(Select.value==="public")
                    SelectStyle("styleGreen");

                SetVisibleEditKeys(0);
                UpdatesData();
            }
        });
    }
    function CancelSavePrivateKey()
    {
        SetVisibleEditKeys(0);
    }




    //ACCOUNTS
    //ACCOUNTS
    //ACCOUNTS
    function FindMyAccounts()
    {
        GetData("FindMyAccounts",{},function (Data)
        {
           UpdatesData();
        });

    }


    function ViewNewAccount()
    {
        var name="edit_create_acc";
        if(IsVisibleBlock(name))
        {
            SetVisibleBlock(name,false);
        }
        else
        {
            SetVisibleBlock(name,true);
            document.getElementById("idAccDescription").focus();

            var Select=document.getElementById("idAccount");
//            if(Select.options.length)
//            {
//                document.getElementById("idAutoSetMining").checked=false;
//            }

            SetViewWN();
        }
    }
    function SetViewWN()
    {
//        if(CONFIG_DATA.CONSTANTS.MAX_WNUM)
//        {
//            document.getElementById("Item.WN").innerText="WN";
//            SetVisibleBlock("idRowWN","table-row");
//            SetVisibleBlock("Item.WN","table-column;");
//        }
//        else
//        {
            document.getElementById("Item.WN").innerText="";
            SetVisibleBlock("Item.WN","none");
//        }
    }
    function CancelCreateAccount()
    {
        var name="edit_create_acc";
        SetVisibleBlock(name,false)
    }

    var WasCreateAccountInfo;
    function CreateAccount(bAddToPay)
    {
        if(!CanSendTransaction)
        {
            SetError("Can't Send transaction");
            return;
        }

        WasCreateAccountInfo=PubKeyStr;

        var Description=document.getElementById("idAccDescription").value;
        var Adviser=ParseNum(document.getElementById("idAdviser").value);
        var Smart=ParseNum(document.getElementById("idSmart").value);
        var Currency=ParseNum(document.getElementById("idCurrency").value);

        var WN=ParseNum(document.getElementById("idWN").value);

        if(!Description)
        {
            SetError("Enter the account name.");
            return;
        }

        if(WN)
        {
            GetData("GetAccountKey",WN,function (Data)
            {
                if(Data && Data.result===1)
                {
                    SendTrCreateAcc(Currency,Data.PubKeyStr,Description,Adviser,Smart,1,bAddToPay);
                }
            });
        }
        else
        {
            SendTrCreateAcc(Currency,PubKeyStr,Description,Adviser,Smart,0,bAddToPay);
        }
    }


    function SendTrCreateAcc(Currency,PubKey,Description,Adviser,Smart,bFindAcc,bAddToPay)
    {
        var TR=GetTrCreateAcc(Currency,PubKey,Description,Adviser,Smart);
        var Body=GetBodyCreateAcc(TR);
        TR.bFindAcc=1;

        if(bAddToPay)
        {
            var Item=
                {
                    name:Description,
                    To:0,
                    Amount:CONFIG_DATA.PRICE_DAO.NewAccount,
                    Description:"Create acc: "+Description,
                    Body:Body,
                };
            AddToInvoiceList(Item);
        }
        else
        {
            //SetStatus("Create: "+PubKey)
            SendTransaction(Body,TR,min_power_pow_acc_create);
        }

        document.getElementById("idAccDescription").value="";
        CancelCreateAccount();
    }


    function ChangeSmart(NumAccount,WasSmart)
    {
        if(!CONFIG_DATA.WalletCanSign)
        {
            SetError("Pls, open wallet");
            return 0;
        }

        var Result=prompt("Enter smart number:", WasSmart);
        if(Result!==null && Result!=WasSmart)
        {
            var Smart=parseInt(Result);
            var OperationID=0;
            var Item=MapAccounts[NumAccount];
            if(Item)
            {
                OperationID=Item.Value.OperationID;
            }
            var TR=
                {
                    Type:140,
                    Account:NumAccount,
                    Smart:Smart,
                    FromNum:NumAccount,
                    Reserve:[],
                    FromNum:NumAccount,
                    OperationID:OperationID,
                    Sign:"",
                };

            var Body=[];
            WriteByte(Body,TR.Type);
            WriteUint(Body,TR.Account);
            WriteUint32(Body,TR.Smart);
            WriteArr(Body,TR.Reserve,10);
            WriteUint(Body,TR.FromNum);
            WriteUint(Body,TR.OperationID);

            SendTrArrayWithSign(Body,TR.Account,TR);
        }
    }


    function CheckLengthAccDesription(name,Length)
    {
        var Str=document.getElementById(name).value.substr(0,Length+1);
        var arr=toUTF8Array(Str);
        var Len=Length-arr.length;
        if(Len<0)
            SetError("Bad length");
        else
            SetStatus("Lost: "+Len+" bytes");
    }

    //RECEIVE



    //SEND
    //SEND
    //SEND
    function ClearTransaction()
    {
        PayList=[];
        ClearAttach();
        CheckSendList(1);


        var arr=["idAccount","idTo","idSumSend","idDescription"];
        for(var i=0;i<arr.length;i++)
        {
            $(arr[i]).value="";
        }
        SaveValues();
        CreateTransaction();
    }

    function StartEditTransactionJSON()
    {
        var Item=document.getElementById("idTransaction");
        Item.className="smallbold";
    }

    function EditJSONTransaction()
    {
        var name="edit_transaction";

        var Item=document.getElementById("idTransaction");
        if(IsVisibleBlock(name))
        {
            SetVisibleBlock(name,false)
            Item.className="";
        }
        else
        {
            CreateTransaction();
            SetVisibleBlock(name,true)
            Item.className="";
        }
    }

    function IsHexStr(Str)
    {
        var arr=GetArrFromHex(Str);
        var Str2=GetHexFromArr(arr);
        if(Str2===Str.toUpperCase())
            return true;
        else
            return false;
    }

    function SetVisibleEditKeys(bSet)
    {
        SetVisibleBlock("edit_keys",bSet);
        if(bSet)
        {
            SetVisibleItemByTypeKey();
            document.getElementById("idKeyNew").focus();
        }
    }

    function SelectTypeKey()
    {
        var Select=document.getElementById("idTypeKey");
        var Item=document.getElementById("idKeyNew");
        var Item2=document.getElementById("idKeyNew2");

        if(Select.value==="public" && (Item.value.length!==66 || Item.value.substr(0,1)!=="0"))
        {
            Item.value="";
            Item2.value="";
        }
        else
        if(Select.value==="private" && Item.value===PubKeyStr)
        {
            Item.value="";
            Item2.value="";
        }
        else
        if(Select.value==="brain" && Item.value.length>=64 && IsHexStr(Item.value))
        {
            Item.value="";
            Item2.value="";
        }

        SetVisibleItemByTypeKey();

    }
    function SetVisibleItemByTypeKey()
    {
        var Select=document.getElementById("idTypeKey");
        if(Select.value==="brain")
        {
            SetVisibleBlock("idViewKeyNew2","table-row");
            SetVisibleBlock("idBtConvertKey","inline-block");
            SetVisibleBlock("idBtSaveKey",false);
        }
        else
        {
            SetVisibleBlock("idViewKeyNew2","none");
            SetVisibleBlock("idBtConvertKey",false);
            SetVisibleBlock("idBtSaveKey","inline-block");
        }
    }


    function CurTransactionToForm(bForce)
    {
        var Item=document.getElementById("idTransaction");
        if(Item.className==="" || bForce)
            Item.value=GetJSONFromTransaction(CurrentTR);
    }

    function CheckNameAccTo()
    {
        var ToID = ParseNum(document.getElementById("idTo").value);
        if(!MapAccounts[ToID] || (MapAccounts[ToID].MustUpdate && MapAccounts[ToID].MustUpdate<=MaxBlockNum))
        {
            GetData("GetAccount",ToID,function (Data)
            {
                if(Data && Data.result===1 && Data.Item)
                {
                    Data.Item.UpdateData=(new Date)-0;
                    MapAccounts[Data.Item.Num]=Data.Item;
                    SetNameAccTo();
                }
            });
        }
        SetNameAccTo();
    }

    function SetNameAccTo()
    {
        var Str="";
        var ToID = ParseNum(document.getElementById("idTo").value);
        var element=document.getElementById("idNameTo");
        var Item=MapAccounts[ToID];
        var StrTo="To: "+GetAccountText(Item,ToID);
        if(element.innerText!==StrTo)
        {
            element.innerText=StrTo;
            if(Item && Item.MyAccount)
                element.className="smallbold";
            else
                element.className="";
        }
    }

    function OnEditIdTo()
    {
        CheckNameAccTo();
        OnEditTransactionFields();
    }
    function OnEditTransactionFields()
    {
        if(IsVisibleBlock("edit_transaction"))
            CreateTransaction();
        SetCurCurencyName();
    }
    function SetCurCurencyName()
    {
        var Num=ParseNum($("idAccount").value);
        var Item=MapAccounts[Num];
        if(Item)
            $("idCoinName").innerText=CurrencyName(Item.Currency);
    }


    function CreateTransaction(F,CheckErr,Run)
    {
        CheckNameAccTo();
        CheckSending();

        var FromID = ParseNum($("idAccount").value);

        if(CheckErr && FromID===0)
        {
            SetError("Select valid 'From account'");
            return;
        }

        var StrTo=$("idTo").value.trim();
        var bFindAcc=0;
        var ToPubKey="";
        var ToID = ParseNum(StrTo);
        if(StrTo!==""+ToID)
        {
            if(StrTo.length===66 && (StrTo.substr(0,2)==="02" || StrTo.substr(0,2)==="03") && IsHexStr(StrTo))
            {
                ToID=0;
                ToPubKey=StrTo;
                if(ToPubKey===PubKeyStr)
                    bFindAcc=1;
            }
            else
            {
                //error
                ToID=0;
                ToPubKey="";
            }
        }

        if(CheckErr && ToID<=0 && ToPubKey==="" && !AttachItem)
        {
            SetError("Valid 'Pay to' - required!");
            return;
        }


        var Description = $("idDescription").value.substr(0,200);

        var StrSum=$("idSumSend").value;
//        if(CheckErr && (StrSum==="0" || StrSum===""))
//        {
//            SetError("Enter not zero 'Amount'");
//            return;
//        }

        var indDot=StrSum.indexOf(".");
        if(indDot>=0)
        {
            var StrTER=StrSum.substr(0,indDot);
            var StrCENT=StrSum.substr(indDot+1);
        }
        else
        {
            var StrTER=StrSum;
            var StrCENT="0";
        }
        StrCENT=StrCENT+"000000000";
        var Coin={SumCOIN:ParseNum(StrTER),SumCENT:ParseNum(StrCENT.substr(0,9))};


        var OperationID=0;
        var Item=MapAccounts[FromID];
        if(Item)
        {
            OperationID=Item.Value.OperationID;
        }

        var AttachBody=[];
        if(AttachItem)
        {
            AttachBody=AttachItem.Data.Body;
            if(!AttachBody)
                AttachBody=[];
        }
        var ToPubKeyArr=[];
        if(ToPubKey)
            ToPubKeyArr=GetArrFromHex(ToPubKey);


        var TR=
            {
                Type:111,
                Version:3,
                Reserve:0,
                FromID:FromID,
                OperationID:OperationID,
                To:[{PubKey:ToPubKeyArr,ID:ToID,SumCOIN:Coin.SumCOIN,SumCENT:Coin.SumCENT}],
                Description:Description,
                Body:AttachBody,
                Sign:CurrentTR.Sign,

            };
        Object.defineProperties(TR, {bFindAcc:{configurable: true, writable: true, enumerable: false, value:bFindAcc}});
        Object.defineProperties(TR, {Run:{configurable: true, writable: true, enumerable: false, value:Run}});



        if(JSON.stringify(TR)===JSON.stringify(CurrentTR))
        {
            if(F)
                F(CurrentTR);
            return;
        }

        CurrentTR=TR;


        GetData("GetSignTransaction",CurrentTR, function (Data)
        {
            if(Data && Data.result===1)
            {
                CurrentTR.Sign=GetArrFromHex(Data.Sign);
                CurTransactionToForm();
                if(F)
                    F(CurrentTR);
            }
        });

    }
    function SignJSON(F)
    {
        if(document.getElementById("idSignJSON").disabled)
            return;

        var TR=GetTransactionFromJSON();
        if(!TR)
            return;
        CurrentTR=TR;


        GetData("GetSignTransaction",TR, function (Data)
        {
            if(Data && Data.result===1)
            {
                TR.Sign=GetArrFromHex(Data.Sign);
                CurTransactionToForm(true);
                if(F)
                    F();
            }
        });
    }

    function CheckSending(bToStatus)
    {
        var CanSend=IsPrivateMode();
        var StrButton="Send";
        var StrButtonSign="Sign JSON";
        if(!CanSend)
        {
            StrButton=" ";
            StrButtonSign=" ";
        }

        if(CanSend)
        {
            var FromID = ParseNum(document.getElementById("idAccount").value);
            var Item=MapAccounts[FromID];
            if(Item && Item.NextSendTime && Item.NextSendTime>MaxBlockNum)
            {
                if(bToStatus)
                    SetStatus("Transaction was sending. Wait... ("+Item.LastTransactionText+")");

                CanSend=false;
                StrButton="Wait...";
            }
        }

        document.getElementById("idSendButton").disabled=(!CanSend);
        document.getElementById("idSendButton").value=StrButton;

        document.getElementById("idSignJSON").disabled=(!CanSend);
        document.getElementById("idSignJSON").value=StrButtonSign;

        return CanSend;
    }
    function SendMoney()
    {
        if(!CanSendTransaction)
        {
            SetError("Can't Send transaction");
            return;
        }


        CheckSending(true);
        if(document.getElementById("idSendButton").disabled)
            return;

        CreateTransaction(SendMoneyTR,true,ClearAttach);
    }

    function GetJSONFromTransaction(TR)
    {
        var TR2=JSON.parse(JSON.stringify(TR));
        for(var i=0;i<TR2.To.length;i++)
        {
            var Item=TR2.To[i];
            //if(typeof Item.PubKey!=="string")
                Item.PubKey=GetHexFromArr(Item.PubKey);
        }
        //if(typeof TR2.Body!=="string")
            TR2.Body=GetHexFromArr(TR2.Body);
        TR2.Sign=GetHexFromArr(TR2.Sign);


        var Str=JSON.stringify(TR2,"",4);
        return Str;
    }
    function GetTransactionFromJSON()
    {
        var Str=document.getElementById("idTransaction").value;
        try
        {
            var TR=JSON.parse(Str);
        }
        catch (e)
        {
            SetError(e);
            return undefined;
        }



        for(var i=0;i<TR.To.length;i++)
        {
            var Item=TR.To[i];
            Item.PubKey=GetArrFromHex(Item.PubKey);
            if(Item.SumTER && Item.SumCOIN===undefined)
            {
                Item.SumCOIN=Item.SumTER;
                delete Item.SumTER;
            }
        }

        TR.Body=GetArrFromHex(TR.Body);
        TR.Sign=GetArrFromHex(TR.Sign);

        return TR;
    }


    function SendMoneyJSON()
    {
        if(!CanSendTransaction)
        {
            SetError("Can't Send transaction");
            return;
        }

        var TR=GetTransactionFromJSON();
        if(!TR)
            return;

        SendMoneyTR(TR);
    }
    function SignAndSendFromJSON()
    {
        SignJSON(SendMoneyJSON);
    }

    function GetTransactionText(TR,key)
    {
        var Str;
        if(TR)
        {
            if(TR.Type===TYPE_TRANSACTION_CREATE)
            {
                Str="New account "+TR.Name.substr(0,20);
            }
            else
            if(TR.Type===111)
            {
                var MapItem={};
                var ValueTotal={SumCOIN:0,SumCENT:0};

                Str=""+TR.FromID+"/"+TR.OperationID+" to ";
                for(var i=0;i<TR.To.length;i++)
                {
                    var Item=TR.To[i];

                    if(Item.ID===TR.FromID || MapItem[Item.ID])
                        continue;
                    MapItem[Item.ID]=1;

                    ADD(ValueTotal,Item);
                    if(i===0)
                        Str+="[";
                    if(Str.length<16)
                    {
                        if(i>0)
                            Str+=",";
                        if(Item.ID || (Item.PubKey && Item.PubKey.length!==66))
                            Str+=Item.ID;
                        else
                            Str+=GetHexFromArr(Item.PubKey).substr(0,8);
                    }
                    else
                    if(Str.substr(Str.length-1)!==".")
                        Str+="...";
                }
                Str+="] "+SUM_TO_STRING(ValueTotal);
                Str+=" "+(TR.Description.substr(0,20)).replace(/\n/g,"");
            }

        }
        else
        {
            if(key)
                Str=key;
            else
                Str="";
        }
        return Str;
    }

    function SendMoneyTR(TR)
    {
        var Body=[];
        WriteByte(Body,TR.Type)
        WriteByte(Body,TR.Version)
        WriteUint(Body,0)//Reserve
        WriteUint(Body,TR.FromID)
        WriteUint32(Body,TR.To.length);
        for(var i=0;i<TR.To.length;i++)
        {
            //To:[{PubKey:tr,ID:uint,SumCOIN:uint,SumCENT:uint32}],
            var Item=TR.To[i];
            if(TR.Version>=3)
                WriteTr(Body,Item.PubKey);
            WriteUint(Body,Item.ID);
            WriteUint(Body,Item.SumCOIN);
            WriteUint32(Body,Item.SumCENT);

            if(MapAccounts[Item.ID])
                MapAccounts[Item.ID].MustUpdate=MaxBlockNum+10;
        }

        WriteStr(Body,TR.Description);
        WriteUint(Body,TR.OperationID);

        //Body
        if(TR.Version>=3)
        {
            if(TR.Body)
            {
                WriteTr(Body,TR.Body);
            }
            else
            {
                WriteByte(Body,0);
                WriteByte(Body,0);
            }
        }

        WriteArr(Body,TR.Sign,64);



        Body.length+=12;

        SendTransaction(Body,TR,undefined,function (Err,TR,Body)
        {
            if(Err)
                return;

            //lock send
            var Item=MapAccounts[TR.FromID];
            if(Item)
            {
                var key=GetHexFromArr(shaarr(Body));
                var BlockNum=GetCurrentBlockNumByTime();
                Item.LastTransactionText=GetTransactionText(TR);
                Item.NextSendTime=BlockNum+10;
                MapCheckTransaction[key]=Item;
                CheckSending();
            }

        });


    }







    //UTIL


    function RewriteAllTransactions()
    {
        DoBlockChainProcess("RewriteAllTransactions","Rewrite all transactions",0);
    }

    function RewriteTransactions()
    {
        DoBlockChainProcess("RewriteTransactions","Rewrite transactions on last %1 blocks",1);
    }

    function TruncateBlockChain()
    {
        DoBlockChainProcess("TruncateBlockChain","Truncate last %1 blocks",1);
    }
    function ClearDataBase()
    {
        DoBlockChainProcess("ClearDataBase","Clear DataBase",0);
    }
    function CleanChain()
    {
        DoBlockChainProcess("CleanChain","Clean chain on last %1 blocks",1);
    }

    function DoBlockChainProcess(FuncName,Text,LastBlock)
    {
        SaveValues();

        var Params={};
        if(LastBlock)
        {
            Params.BlockCount=ParseNum(document.getElementById("idBlockCount").value);
            Text=Text.replace("%1",Params.BlockCount);
        }
        var result = confirm(Text+"?");
        if(!result)
            return;


        SetVisibleBlock("idServerBlock",1);
        SetStatus("START: "+Text);


        GetData(FuncName,Params, function (Data)
        {
            if(Data)
            {
                SetStatus("FINISH: "+Text,!Data.result);
            }
        });
    }


</script>


<script>

    //Pagination
    var CountViewRows=20;
    var DefAccounts={BlockName:"idPaginationAccount", NumName:"idViewAccountNum", TabName:"grid_accounts_all",APIName:"GetAccountsAll",Param3:"",FilterName:"idViewAccountFilter",TotalSum:"idTotalSum"};
    var DefBlock={BlockName:"idPaginationBlock", NumName:"idViewBlockNum", TabName:"grid_block_all",APIName:"GetBlockAll",Param3:"",FilterName:""};//idViewBlockFilter


    var DefHistory={BlockName:"idPaginationHistory", NumName:"idViewHistoryNum", TabName:"grid_history",APIName:"GetHistoryAct",Param3:"",FilterName:"idViewHistoryFilter",TotalSum:"idTotalSumH"};
    var DefActs={BlockName:"idPaginationAct", NumName:"idViewActNum", TabName:"grid_acts_all",APIName:"GetActsAll",Param3:""};
    var DefHash={BlockName:"idPaginationHash", NumName:"idViewHashNum", TabName:"grid_hash_all",APIName:"GetHashAll",Param3:""};

    var DefDapps={BlockName:"idPaginationDapps", NumName:"idViewDappNum", TabName:"grid_dapps_all",APIName:"GetDappsAll",Param3:"",FilterName:"idViewDappsFilter",FilterName2:"idCategory",CountViewRows:10};



    function ViewHistory()
    {
        ViewCurrent(DefHistory);
    }
    function ViewDapps()
    {
        ViewCurrent(DefDapps);
    }


    var MapCheckBtPress={};
    var ArrCheckEscPress=[];
    function SetImg(This,Name)
    {
        if(!This)
            return;

        MapCheckBtPress[Name]=This;

        if(IsVisibleBlock(Name))
        {
            This.id="idUp";

            for(var i=ArrCheckEscPress.length-1;i>=0;i--)
            {
                var element=ArrCheckEscPress[i];
                if(element.name===Name)
                {
                    return;
                }
            }


            ArrCheckEscPress.push({name:Name,item:This,tab:CurTabName});
        }
        else
        {
            This.id="idDown";
        }
        //console.log("This="+This.value);
    }
    setInterval(function ()
    {
        for(var key in MapCheckBtPress)
        {
            var item=MapCheckBtPress[key];
            SetImg(item,key);
        }
    },300);


</script>




<script>

    /*Get data from server Get data from server Get data from server Get data from server Get data from server */
    function UpdatesConfigData()
    {
        GetData("GetWalletInfo",{}, function (Data)
        {
            SetConfigData(Data);
        });
    }
    function UpdatesAccountsData()
    {
        GetData("/GetWalletAccounts",{}, function (Data)
        {
            SetAccountsData(Data);
        });
    }

    function UpdatesData()
    {

        UpdatesAccountsData();
        CheckNameAccTo();
        CheckSending();
    }



    function GetAccountText(Item,Num)
    {
        if(Item)
        {
            var text=Item.Name;
            if(!text || text.length===0)
                text=Num;
            else
                text=""+Num+". "+text;
            var StrSum=SUM_TO_STRING(Item.Value,Item.Currency);
            text+=" ("+StrSum+")";

            return text;
        }
        else
        {
            return Num;
        }
    }
    function SetAccountsData(Data)
    {
        if(!Data || !Data.result)
            return;
        var arr=Data.ArrAcc;

        if(arr.length===0 && WasCreateAccountInfo!==PubKeyStr && WalletStatus==="OK")
        {
            WalletStatus="";

            SelectTab('TabAccounts');
            SetVisibleBlock("edit_create_acc",false);
            ViewNewAccount();
        }

        //select list
        var Select=document.getElementById("idAccount");
        if(arr.length!==Select.options.length)
        {
            var options=Select.options;
            options.length=arr.length;
        }

        SetGridData(arr,"grid_accounts","idMyTotalSum");
        for(var i=0;arr && i<arr.length;i++)
        {
            var Item=arr[i];
            Item.MyAccount=true;

            var Num=ParseNum(Item.Num);
            if(!MapAccounts[Num])
                MapAccounts[Num]={};
            CopyObjKeys(MapAccounts[Num],Item);


            var option=Select.options[i];
            option.text=GetAccountText(Item,Num);
            option.value=Num;
        }

        var CurentValue=LoadMapAfter["idAccount"];
        if(CurentValue)
        {
            Select.value=CurentValue;
            delete LoadMapAfter["idAccount"];
        }

        SetCurCurencyName();
    }

    var TitleWarning=0;
    function SetTitle(TitleName)
    {
        if(TitleWarning===1)
            document.title="*"+TitleName+"*";
        else
        if(TitleWarning===2)
            document.title="**"+TitleName+"**";
        else
        if(TitleWarning>2)
            document.title="***"+TitleName+"***";
        else
            document.title=TitleName;
    }
    function SetConfigData(Data)
    {
        if(!Data || !Data.result)
            return;

        CONFIG_DATA=Data;
        ServerBlockNumDB=Data.BlockNumDB;
        ServerCurBlockNum=Data.CurBlockNum;
        ServerTime=Data.CurTime;
        var DeltaTime=Data.DELTA_CURRENT_TIME/1000;

        var Name="TERA";
        if(CONFIG_DATA.CONSTANTS.WALLET_NAME)
            Name=CONFIG_DATA.CONSTANTS.WALLET_NAME;

        SetTitle(Name+" 0."+Data.VersionNum);

        if(CONFIG_DATA.CONSTANTS.COUNT_VIEW_ROWS)
            CountViewRows=CONFIG_DATA.CONSTANTS.COUNT_VIEW_ROWS;

        SetBlockChainConstant(Data);
        MaxBlockNum=GetCurrentBlockNumByTime();

        if(Data.RelayMode || !Data.CurBlockNum || !Data.BlockNumDB || Data.CurBlockNum>Data.BlockNumDB+BLOCK_PROCESSING_LENGTH*2)
        {
            CanSendTransaction=0;
            var StrMode="";
            var MaxNum=Data.CurBlockNum-BLOCK_PROCESSING_LENGTH;
            if(MaxNum>0)
            {
                var Percent=100*Data.BlockNumDB/MaxNum;
                if(Percent<0)
                    Percent=0;
                Percent=Percent.toFixed(2);
                StrMode=" "+Percent+"% "+" ("+Data.BlockNumDB+"/"+MaxNum+")";
            }

            SetMainStatus("<DIV align='center' style='color:red'><big><B>Waiting for synchronization "+StrMode+"</B></big></DIV>");
            WalletStatus="WAIT";
        }
        else
        if(WalletStatus==="WAIT")
        {
            CanSendTransaction=1;
            WalletStatus="OK";
            SetMainStatus("<DIV align='center' style='color:green'><big><B>Synchronization complete</B></big></DIV>",1);
        }
        else
        {
            CanSendTransaction=1;
        }

        MaxAccID=Data.MaxAccID;
        MaxDappsID=Data.MaxDappsID;
        MaxActNum=Data.MaxActNum;
        //MaxBlockNum=Data.CurBlockNum;
//        if(MaxBlockNum!==Data.CurBlockNum)
//            SetStatus("Client num="+MaxBlockNum+"  server num="+Data.CurBlockNum)


        min_power_pow_acc_create=Data.MIN_POWER_POW_ACC_CREATE+3;
        PubKeyStr=Data.PublicKey;
        PrivKeyStr=Data.PrivateKey;

        WalletOpen=Data.WalletOpen;
        SetVisibleBtOpenWallet();

        HistoryMaxNum=Data.HistoryMaxNum;

        DeltaTime=DeltaTime.toFixed(3);
        var Str="Saved block: <B>"+Data.BlockNumDB+"</B>  Current block: <B>"+Data.CurBlockNum+"</B> Time delta:<B>"+DeltaTime+" sec</B>";
        document.getElementById("idCurrentBlockNum").innerHTML=Str;





        SetArrLog(Data.ArrLog);

        if(document.getElementById("idPubKey").innerText!==PubKeyStr)
            document.getElementById("idPubKey").innerText=PubKeyStr;
        if(document.getElementById("idDataPath").innerText!==Data.DATA_PATH)
            document.getElementById("idDataPath").innerText=Data.DATA_PATH;
        if(document.getElementById("idNodeAddr").innerText!==Data.NodeAddrStr)
            document.getElementById("idNodeAddr").innerText=Data.NodeAddrStr;

        //document.getElementById("idTo").max=MaxAccID;
        document.getElementById("idAdviser").max=MaxAccID;

        SetVisibleBlock("idDevelopService",Data.IsDevelopAccount);
        SetVisibleBlock("idDevelopService2",Data.IsDevelopAccount);
//        SetVisibleBlock("idFilterA",Data.IsDevelopAccount);
        //SetVisibleBlock("idFilterB",Data.IsDevelopAccount);
        //SetVisibleBlock("idFilterH",Data.IsDevelopAccount);

        //SetVisibleBlock("idNetwork",CONFIG_DATA.CONSTANTS.COMMON_KEY);




        if(Data.NeedRestart)
        {
            SetStatus("<H1 align='center' style='color:blue'>Restarting program...</H1>");
            if(!WasSetRestart)
            {
                WasSetRestart=1;
                setTimeout(function ()
                {
                    window.location.reload();
                },10*1000)
            }
        }


        INTERNET_IP_FROM_STUN=Data.INTERNET_IP_FROM_STUN;
        SERVER_IP=Data.ip;
        SERVER_PORT=Data.port;

        //Mining
        MiningAccount=Data.MiningAccount;
        document.getElementById("idUseMining").checked=CONFIG_DATA.CONSTANTS.USE_MINING;
        if(!idPercentItem || document.activeElement!==idPercentItem)
        {
            idPercentItem=document.getElementById("idPercentMining");
            idPercentItem.value=CONFIG_DATA.CONSTANTS.POW_MAX_PERCENT;
        }
        if(Data.CountMiningCPU>0 && CONFIG_DATA.CONSTANTS.USE_MINING)
            SetVisibleBlock("idMiningParams","inline-block");
        else
            SetVisibleBlock("idMiningParams",0);

        SetStatusMining(" Mining on:<B>"+MiningAccount+"</B>  HashRate:<B>"+(Math.trunc(Data.HashRate*10)/10)+"</B>Mh/s CPU RUN:<B>"+Data.CountRunCPU+"</B>/"+Data.CountMiningCPU+" "+(Data.MiningPaused?"<B style='color:darkred;'>=PAUSED=</B>":""));
        if(CONFIG_DATA.CONSTANTS.USE_MINING && Data.CountRunCPU!==Data.CountMiningCPU)
        {
            $("idUseMining").className="checkbox checkbox_red";
        }
        else
        {
            $("idUseMining").className="checkbox";
        }

        if(Data.CODE_VERSION.VersionNum && Data.VersionNum<Data.CODE_VERSION.VersionNum)
        {
            SetTitle(Name+" 0."+Data.VersionNum+"/"+Data.CODE_VERSION.VersionNum);
            $("idAutoUpdate").className="checkbox checkbox_alert";
        }
        else
        {
            $("idAutoUpdate").className="checkbox";
        }

        document.getElementById("idAutoUpdate").checked=CONFIG_DATA.CONSTANTS.USE_AUTO_UPDATE;

        //DappSecret=Data.DappSecret;

        window.DEBUG_WALLET=CONFIG_DATA.CONSTANTS.DEBUG_WALLET;


        SetViewWN();
    }

    var WasHistoryMaxNum;
    var WasLastNumSound=0;
    function CheckNewMoney()
    {
        if(!$("idUseSoundHistory").checked)
            return;

        if(WasHistoryMaxNum===HistoryMaxNum  || !ServerBlockNumDB)
            return;

        WasHistoryMaxNum=HistoryMaxNum;


        GetData("GetHistoryAct",{StartNum:HistoryMaxNum-40,CountNum:40},function (Data)
        {
            if(Data && Data.result)
            {
                var arr=Data.arr;
                for(var i=0;i<arr.length;i++)
                {
                    var Item=arr[i];

                    if(Item.Direct==="+" && Item.BlockNum>ServerBlockNumDB-60 && Item.BlockNum<ServerBlockNumDB-20 && Item.BlockNum>WasLastNumSound)
                    {
                        WasLastNumSound=Item.BlockNum;
                        //SetStatus("Sound: "+WasLastNumSound);
                        $("sound_coin").play();
                    }
                }
            }
        });
    }

    function SetVisibleBtOpenWallet()
    {
        SetVisibleBlock("idOpenWallet",WalletOpen!==undefined);
        var item=document.getElementById("idOpenWallet");
        if(WalletOpen==true)
        {
            item.value="Wallet opened";
            item.style="background-image: url('/HTML/PIC/lock_open.png');color:green;";
        }
        else
        if(WalletOpen==false)
        {
            item.value="Wallet closed";
            item.style="background-image: url('/HTML/PIC/lock_closed.png');color:"+"#9b712a";
        }

        SetVisibleBlock("wallet_config_tab",WalletOpen!==false);
    }

    function SetArrLog(arr)
    {
        var Str="";
        var bFindAccount=0;
        for(var i=0;i<arr.length;i++)
        {
            var Item=arr[i];

            var tr_text=GetTransactionText(MapSendTransaction[Item.key],Item.key.substr(0,16));
            var info=Item.text;
            if(tr_text)
                info+=" ("+tr_text+")";

            if(Item.final)
            {
                var TR=MapSendTransaction[Item.key];
                if(TR)
                {
                    if(Item.text.indexOf("Add to blockchain")>=0)
                    {
                        if(TR.bFindAcc)
                        {
                            bFindAccount=1;
                            TR.bFindAcc=0;
                        }
                        if(TR.Run)
                        {
                            TR.Run(TR);
                            TR.Run=undefined;
                        }
                    }
                }



                var Account=MapCheckTransaction[Item.key];
                if(Account)
                {
                    delete MapCheckTransaction[Item.key];
                    Account.NextSendTime=0;
                }
            }

            Str=Str+info+"\n";
        }
        SetStatusFromServer(Str);
        CheckSending();

        if(bFindAccount)
        {
            FindMyAccounts();
        }
    }
    function SetAutoMining()
    {
        setTimeout(function ()
        {
            var Select=$("idAccount");
            if(Select.options.length)
            {
                SaveMiningSet(Select.options[Select.options.length-1].value)
            }
        },100);//start after insert new account in select list
    }


    //NetworkParams
    //NetworkParams
    //NetworkParams
    function ViewNetworkMode()
    {
        if(IsVisibleBlock('idNetworkView'))
        {
            SetVisibleBlock('idNetworkView',false);
        }
        else
        {
            SetVisibleBlock('idNetworkView',true);

            var Mode=CONFIG_DATA.CONSTANTS.NET_WORK_MODE;
            if(!Mode)//default:
            {
                Mode={};
                Mode.UseDirectIP=true;

                if(INTERNET_IP_FROM_STUN)
                    Mode.ip=INTERNET_IP_FROM_STUN;
                else
                    Mode.ip=SERVER_IP;
                Mode.port=SERVER_PORT;
            }


            document.getElementById("idUseDirectIP").checked=Mode.UseDirectIP;
            document.getElementById("idIP").value=Mode.ip;
            document.getElementById("idPort").value=Mode.port;
            if(!Mode.NodeWhiteList)
                Mode.NodeWhiteList="";
            document.getElementById("idNodeWhiteList").value=Mode.NodeWhiteList;

        }
    }


    function SetNetworkParams(bRestart)
    {

        var Mode={};
        Mode.UseDirectIP=document.getElementById("idUseDirectIP").checked;
        Mode.ip=document.getElementById("idIP").value;
        Mode.port=ParseNum(document.getElementById("idPort").value);
        //Mode.UseIncomeGrayIP=document.getElementById("idUseIncomeGrayIP").checked;
        Mode.NodeWhiteList=document.getElementById("idNodeWhiteList").value;


        Mode.DoRestartNode=bRestart;

        GetData("SetNetMode",Mode, function (Data)
        {
            if(Data && Data.result)
            {
                SetStatus("Set net work params OK");
                SetVisibleBlock('idNetworkView',false);
            }
        });

    }

    //CONSTANT
    function ViewConstant()
    {
        if(IsVisibleBlock('idConstantView'))
        {
            SetVisibleBlock('idConstantView',false);
        }
        else
        {
            SetVisibleBlock('idConstantView',true);
            document.getElementById("idConstant").value=JSON.stringify(CONFIG_DATA.CONSTANTS,"",2);
        }
    }
    function SaveConstant(bRestart)
    {
        try
        {
            var Data=JSON.parse(document.getElementById("idConstant").value);
        }
        catch (e)
        {
            SetError("Error JSON format setting constant");
            return;
        }

        Data.DoRestartNode=bRestart;

        GetData("SaveConstant",Data, function (Data)
        {
            if(Data && Data.result)
            {
                SetStatus("Save Constant OK");
                SetVisibleBlock('idConstantView',false);
            }
        });
    }


    //REMOTE HTTP
    function ViewRemoteParams()
    {
        if(IsVisibleBlock('idRemoteView'))
        {
            SetVisibleBlock('idRemoteView',false);
        }
        else
        {
            SetVisibleBlock('idRemoteView',true);
            if(CONFIG_DATA.HTTPPort)
                document.getElementById("idHTTPPort").value=CONFIG_DATA.HTTPPort;
            document.getElementById("idHTTPPassword").value=CONFIG_DATA.HTTPPassword;

        }
    }
    function SetRemoteParams(bRestart)
    {
        var PrevHTTPPassword=HTTPPassword;
        var HTTPPort=ParseNum(document.getElementById("idHTTPPort").value);
        var HTTPPassword=document.getElementById("idHTTPPassword").value;

        GetData("SetHTTPParams",{HTTPPort:HTTPPort,HTTPPassword:HTTPPassword,DoRestartNode:bRestart}, function (Data)
        {
            if(!PrevHTTPPassword && HTTPPassword)
                window.location.reload();
            else
            {
                SetVisibleBlock('idRemoteView',false);
                SetStatus("Set HTTP params OK");
            }
        });
    }

</script>



<script>


    //LIB
    function ConfirmationFromBlock(BlockNum)
    {
        var Length=MaxBlockNum-8-BlockNum;
        if(Length>0)
        {
            if(Length<=100)
                return Length;
            else
            {
                return ">"+Math.floor(Length/100)*100;
            }
        }
        else
            return "";
    }





    function ToLogServer(Str)
    {
        GetData("ToLogServer",Str, function (Data)
        {
            UpdatesData();
        });
    }

    var PrevServerStr;
    function SetStatusFromServer(Str)
    {
        var id = document.getElementById("idServerLog");
        if(PrevServerStr!==Str)
        {
            PrevServerStr=Str;
            id.innerText=Str;
        }
    }

    var bMainCanClear=true;
    var StrMainStatus="";
    var StrNormalStatus="";
    function SetMainStatus(Str,bCanClear)
    {
        bMainCanClear=bCanClear;
        StrMainStatus=Str;
        ViewStatus();
    }
    function SetStatus(Str,bError)
    {
        if(bError)
            return SetError(Str);

        StrNormalStatus=Str;
        if(bMainCanClear)
        {
            StrMainStatus="";
        }
        ViewStatus();
    }

    function ViewStatus()
    {
        var Str=StrMainStatus+StrNormalStatus;
        var id = $("idStatus");
        id.innerHTML=Str;
    }
    function SetError(Str,bNoSound)
    {
        if(!bNoSound)
            $("sound_err").play();
        SetStatus("<DIV  align='left' style='color:red'><B>"+Str+"</B></DIV>");
    }
    function SetStatusMining(Str)
    {
        var id = $("idStatusMining");
        id.innerHTML=Str;
    }


    //EVENTS
    //EVENTS
    //EVENTS
    function SetVisibleTab()
    {
        if(!CurTabName)
            CurTabName=TabArr[0].name;

        var bLogVisible=0;
        var str;
        for (var i=0;i<TabArr.length;i++)
        {
            var name=TabArr[i].name;
            var Item=document.getElementById(name);
            if(!Item)
                continue;
            if(CurTabName===name)
            {
                bLogVisible=TabArr[i].log;
                Item.style.display = 'block';
                str="current bt bttab"
            }
            else
            {
                Item.style.display = 'none';
                str="bttab bt"
            }

            var ItemM=document.getElementById("M"+name);
            if(ItemM)
                ItemM.className=str;
        }



        //SetVisibleBlock("idStatus",bLogVisible);
        SetVisibleBlock("idServerBlock",bLogVisible);
    }

    function OnSelectTab(name)
    {
        if(name==="TabHistory")
        {
            ViewHistory();
        }
        else
        if(name==="TabDapps")
        {
            ViewDapps();
        }
    }

    function SelectTab(name)
    {
        CurTabName=name;
        OnSelectTab(name);

        SetVisibleTab();
        SaveValues();
    }

    function CheckCtrlEnterAndESC(e,F)
    {
        SaveValues();

        if(e.ctrlKey && e.keyCode===13)
        {

            if(CurTabName==="TabAccounts" && IsVisibleBlock("edit_keys"))
                SavePrivateKey();
            else
            if(CurTabName==="TabAccounts" && IsVisibleBlock("edit_create_acc"))
                CreateAccount(0);
            else
            if(CurTabName==="TabAccounts" && IsVisibleBlock("edit_mining_set"))
                SaveMiningSet();
            else
            if(CurTabName==="TabSend")
            {
                if(IsVisibleBlock("edit_transaction"))
                    SignAndSendFromJSON();
                else
                    SendMoney();

            }
            else
            if(IsVisibleBlock("idBlockPassword"))
                SetPassword();
            else
                if(WalletOpen===false)
                {
                    ViewOpenWallet();
                }
        }
        else
        if(e.keyCode===27)
        {
            for(var i=ArrCheckEscPress.length-1;i>=0;i--)
            {
                var element=ArrCheckEscPress[i];
                if(element.tab===CurTabName)
                {
                    SetVisibleBlock(element.name,false);
                    SetImg(element.item,element.name);
                    ArrCheckEscPress.splice(i,1);
                    break;
                }
            }
       }

    }

    function LoadValues()
    {
        if(LoadValuesByArr(SaveIdArr))
        {
            CurTabName=localStorage["CurTabName"];

            LoadMapAfter["idAccount"]=localStorage.getItem("idAccount");

        }
    }
    function SaveValues()
    {
        SaveValuesByArr(SaveIdArr);
        localStorage["CurTabName"]=CurTabName;
    }

    //INIT
    //INIT
    //INIT
    function SelectStyle(value)
    {
        var Select=document.getElementById("idSelStyle");
        if(value)
            Select.value=value;

        if(!Select.value)
            Select.value=Select.options[0].value;
        document.body.className=Select.value;
    }
    window.onload=function()
    {
        FillCategory("idCategory");

        LoadValues();
        InitPasItems();

        UpdatesConfigData();
        UpdatesData();

        setInterval(UpdatesData,1000);
        setInterval(UpdatesConfigData,335);
        setInterval(CheckNewMoney,1000);

        SelectStyle();
        SelectTypeKey();

        window.onkeydown = CheckCtrlEnterAndESC;
        setInterval(SaveValues,2000);


        SetVisibleTab();
        setTimeout(CheckNameAccTo,100);

        setTimeout(function ()
        {
            OnSelectTab(CurTabName);
        },100)


        if(localStorage["WasStart"]!=="1")
        {
            var ValText=document.getElementById("idRunText").value;
            if(ValText && ValText!=="undefined" && ValText.trim())
            {
                localStorage["WasStart"]="1";
                SetError("Run script ... Was Error?",1);
                eval(ValText);
                SetStatus("Run script ... OK");
            }
            localStorage["WasStart"]="0";
        }


    }
    function SetRun()
    {
        SaveValues();
        localStorage["WasStart"]="0";
        SetStatus("Set to Run script");
    }


</script>

<script>
    function CreateCheckPoint()
    {
        if(!ServerBlockNumDB || ServerBlockNumDB<16)
        {
            SetError("Not set ServerBlockNumDB");
            return;
        }
        var BlockNum=ServerBlockNumDB-10;
        SetCheckPoint(BlockNum);
    }

    function UseAutoCheckPoint()
    {
        var Set=$("idUseAutoCheckPoint").checked;
        var Period=ParseNum($("idPeriodAutoCheckPoint").value);
        GetData("SetAutoCheckPoint",{Set:Set,Period:Period},function (Data)
        {
            if(Data)
            {
                SetStatus(Data.text,!Data.result);
            }
        });
    }
    function UseAutoCorrTime()
    {
        GetData("SetAutoCorrTime",document.getElementById("idUseAutoCorrTime").checked,function (Data)
        {
            if(Data)
            {
                SetStatus(Data.text,!Data.result);
            }
        });
    }

    function SetCodeVersion()
    {
        var Data=JSON.parse(JSON.stringify(CONFIG_DATA.CODE_VERSION));
        if(!Data.BlockNum)
        {
            Data.LevelUpdate=160;
        }

        Data.VersionNum++;
        Data.BlockNum=CONFIG_DATA.CurBlockNum;
        Data.addrArr=GetHexFromArr(Data.addrArr);
        Data.Hash=GetHexFromArr(Data.Hash);
        Data.Sign=GetHexFromArr(Data.Sign);
        Data.Hash=undefined;//Data.Hash.substr(0,8)+"...";
        Data.Sign=undefined;//Data.Sign.substr(0,16)+"...";
        Data.StartLoadVersionNum=undefined;


        var Str=JSON.stringify(Data,"",2);
        document.getElementById("idDevService").value=Str;

    }

    function SetNewCodeVersion()
    {
        try
        {
            var Data=JSON.parse(document.getElementById("idDevService").value);
        }
        catch (e)
        {
            SetError("Error format setting data");
            return;
        }
        Data.addrArr=GetArrFromHex(Data.addrArr);

        GetData("SetNewCodeVersion",Data,function (Data)
        {
            if(Data)
            {
                SetStatus(Data.text,!Data.result);
            }
        });
    }

    function SetCorrTime()
    {
        var AutoDelta=parseInt(document.getElementById("idDevValue").value);
        var Data={Num:CONFIG_DATA.CurBlockNum,bUse:1,bAddTime:1};
        if(AutoDelta<0)
        {
            AutoDelta=-AutoDelta;
            Data.bAddTime=0;
        }
        Data.DeltaTime=40;

        Data.StartBlockNum=ServerCurBlockNum+10;

        Data.EndBlockNum=Data.StartBlockNum+Math.trunc(AutoDelta/Data.DeltaTime);

        var Str=JSON.stringify(Data,"",2);
        document.getElementById("idDevService").value=Str;

    }

    function StartTimeCorrect()
    {
        try
        {
            var Data=JSON.parse(document.getElementById("idDevService").value);
        }
        catch (e)
        {
            SetError("Error format setting data");
            return;
        }


        GetData("SetCheckDeltaTime",Data,function (Data)
        {
            if(Data)
            {
                SetStatus(Data.text,!Data.result);
            }
        });
    }


    function RestartNode()
    {
        GetData("RestartNode",{});
    }




    function UseAutoUpdate()
    {
        var Data={USE_AUTO_UPDATE:document.getElementById("idAutoUpdate").checked,DoMining:1};

        GetData("SaveConstant",Data, function (Data)
        {
            if(Data && Data.result)
            {
                SetStatus("Save AutoUpdate: "+document.getElementById("idAutoUpdate").checked);
            }
        });
    }
    function UseMining()
    {
        if(!MiningAccount)
        {
            SetError("Not set mining account");
            return;
        }
        var Data={USE_MINING:document.getElementById("idUseMining").checked,DoMining:1};
//        if(Data.USE_MINING)
//            Data.ForceLoadNewVersion=1;

        GetData("SaveConstant",Data, function (Data)
        {
            if(Data && Data.result)
            {
                SetStatus("Save Mining: "+document.getElementById("idUseMining").checked);
            }
        });
    }
    function SetPercentMining()
    {
        var Data={POW_MAX_PERCENT: document.getElementById("idPercentMining").value};

        GetData("SaveConstant",Data, function (Data)
        {
            if(Data && Data.result)
            {
                SetStatus("Save Mining percent: "+document.getElementById("idPercentMining").value+" %");
            }
        });
    }


</script>

<script>
    var itemPassword1,itemPassword2,itemBtPassword;
    function InitPasItems()
    {
        itemPassword1=document.getElementById("idPassword1");
        itemPassword2=document.getElementById("idPassword2");
    }

    function OnClickOpenCloseWallet()
    {
        if(WalletOpen===true)
        {
            GetData("CloseWallet",{},function (Data)
            {
                if(Data && Data.result===1)
                {
                    SetStatus("Wallet close");
                }
            });
        }
        else
        if(WalletOpen===false)
        {
            ViewOpenWallet();
        }

    }

    function ViewOpenWallet()
    {
        if(WalletOpen!==false)
        {
            SetStatus("Wallet not close");
            return;
        }

        itemPassword1.onkeydown = OnEnterPas1;
        itemPassword1.value="";
        SetVisibleBlock("idBlockPassword",true);
        SetVisibleBlock("idPasswordRow2","none");
        itemPassword1.focus();
    }
    function OpenWallet()
    {
        var Passwd1=itemPassword1.value;
        GetData("OpenWallet",Passwd1, function (Data)
        {
            if(Data && Data.result===1)
            {
                itemPassword1.value="";
                SetStatus("Wallet open");
                SetVisibleBlock("idBlockPassword",false);
                SetImg(itemBtPassword,'idBlockPassword');
            }
            else
            {
                SetError("Wrong password!")
            }
        });

    }
    function CancelOpenWallet()
    {
        SetVisibleBlock("idBlockPassword",false);
        SetImg(itemBtPassword,'idBlockPassword');
    }


    function ViewSetPassword()
    {
        if(WalletOpen===false)
        {
            SetError("First open wallet!");
            return;
        }

        itemPassword1.onkeydown = OnEnterPas1;
        itemPassword2.onkeydown = OnEnterPas2;

        itemPassword1.value="";
        itemPassword2.value="";
        SetVisibleBlock("idBlockPassword",!IsVisibleBlock("idBlockPassword"));
        SetVisibleBlock("idPasswordRow2","table-row");
        SetImg(itemBtPassword,'idBlockPassword');
        itemPassword1.focus();
    }


    function SetPassword()
    {
        if(!IsVisibleBlock("idPasswordRow2"))
        {
            OpenWallet();
            return;
        }

        var Passwd1=itemPassword1.value;
        var Passwd2=itemPassword2.value;
        if(Passwd1!==Passwd2)
        {
            SetError("Passwords are not equal");
            return;
        }
        itemPassword1.value="";
        itemPassword2.value="";

        GetData("SetWalletPasswordNew",Passwd1, function (Data)
        {
            if(Data && Data.result===1)
            {
                SetStatus("New password was set");
                SetVisibleBlock("idBlockPassword",false);
                SetImg(itemBtPassword,'idBlockPassword');
            }
        });
    }
    function CancelSetPassword()
    {
        SetVisibleBlock("idBlockPassword",false);
        SetImg(itemBtPassword,'idBlockPassword');
    }

    function OnEnterPas1(e)
    {
        if(e.keyCode===13)
        {
            if(IsVisibleBlock("idPasswordRow2"))
            {
                itemPassword2.focus();
            }
            else
            {
                OpenWallet();
            }
        }
        //SetStatus("e.keyCode="+e.keyCode)
    }
    function OnEnterPas2(e)
    {
        if(e.keyCode===13)
        {
            SetPassword();
        }
        //SetStatus("e.keyCode="+e.keyCode)
    }


</script>

<style type="text/css">

    table.password
    {
        border-collapse: collapse;
        width: 400px;
    }

    #idOpenWallet
    {
        z-index:1001;
        position:relative;
        float: right;
        top:15px;
        right:0px;
        padding: 0 0 0 20px;
        text-align: center;
        box-shadow: 0 0 0 1px;

        width: 130px;
        height: 40px;
        line-height: 20px;
        margin: 10px;
        background: transparent;
        font-weight: 600;

        background-image: url('/HTML/PIC/lock_closed.png');
        background-repeat: no-repeat;
        background-size: 20%;
        cursor: pointer;
    }

    #idBlockPassword
    {
        z-index:1000;
        position:absolute;
        top:150px;
        right:25%;
        height:150px;
        width:320px;
        padding: 10px;
        background: #d9d9d9;
        text-align: left;
        box-shadow: 0 0 0 1px;

        background-image: url('/HTML/PIC/key.png');
        background-repeat: no-repeat;

    }

</style>



<body>
<DIV align='center'>
<DIV align='left' style="width: 800px;height: 920px; border: 1px solid #bfc1c0;">

    <table id="TabHeader">
        <tr>
            <th><INPUT id="MTabAccounts" type="button" onclick="SelectTab('TabAccounts')" class="bttab" value="CONFIG"></th>
            <th><INPUT id="MTabSend" type="button" onclick="SelectTab('TabSend')" class="bttab" value="SEND"></th>
            <th><INPUT id="MTabHistory" type="button" onclick="SelectTab('TabHistory')" class="bttab" value="HISTORY"></th>
            <th><INPUT id="MTabDapps" type="button" onclick="SelectTab('TabDapps')" class="bttab" value="DApps"></th>
            <th><INPUT id="MTabExplorer" type="button" onclick="SelectTab('TabExplorer')" class="bttab" value="EXPLORER"></th>
        </tr>
    </table>

    <INPUT id="idOpenWallet" style="display: none" type="button" onclick="OnClickOpenCloseWallet()" value="Wallet closed">

    <DIV id="idStatus">&nbsp;</DIV>
    <BR><BR><BR>

    <DIV id="TabAccounts" style="display: block">
        <BR>
        <DIV>
            <DIV style="float: left">
                <input type="checkbox" class="checkbox" id="idAutoUpdate" onchange = "UseAutoUpdate()"/>
                <label for="idAutoUpdate">Autoupdate</label>
            </DIV>
            <DIV style="float: left">
                <input type="checkbox" class="checkbox" id="idUseMining" onchange = "UseMining()"/>
                <label for="idUseMining">Mining</label>
            </DIV>
            <DIV style="float: left;display: none" id="idMiningParams">
            <DIV style="float: left; color: blue;">CPU use:<input type="number" min=0 max=100 id="idPercentMining" onchange="SetPercentMining()"/>%</DIV>
            <DIV style="float: left; margin: 2px 0 0 8px;" id="idStatusMining"></DIV>
            </DIV>
        </DIV>
        <BR>
        <DIV id="idDevelopService" style="display: none">
            <BR>
            <INPUT type="button" id="idDown" onclick="SetVisibleBlock('idDevelopServiceView',!IsVisibleBlock('idDevelopServiceView'));SetImg(this,'idDevelopServiceView')"
                   class="btdoit bt" value="DEV SERVICE">
            <DIV id="idDevelopServiceView" style="display: none">

                <table>
                    <tr>
                        <td style="width: 100px">
                            <BR>
                            <INPUT type="button" class="bt btdoit" onclick="SetCodeVersion()" value="CODE VERS>>"><BR>
                            <INPUT type="button" class="bt btdoit" onclick="SetCorrTime()" value="DELTA TIME >>"><BR>

                        </td>
                        <td style="width: 500px">
                            Value:<INPUT type="string" id="idDevValue" value="0"><BR>
                            <TEXTAREA id="idDevService" rows="15" cols="90"> </TEXTAREA><BR>
                        </td>
                        <!--<td style="width: 100px">-->
                        <!--</td>-->
                    </tr>
                </table>
                <INPUT type="button" onclick="CreateCheckPoint()" class="btdoit  bt" value="CHECK POINT">
                <INPUT type="button" onclick="SetNewCodeVersion()" class="btdoit  bt" value=">>NEW VERSION">
                <INPUT type="button" onclick="StartTimeCorrect()" class="btdoit  bt" value=">>TIME CORR.">


                <input type="checkbox" class="checkbox" id="idUseAutoCheckPoint" onchange = "UseAutoCheckPoint()"/>
                <label for="idUseAutoCheckPoint">Auto check point each :</label>
                <INPUT type="number" id="idPeriodAutoCheckPoint" style="width: 60px" value="10"> sec<BR>



                <input type="checkbox" class="checkbox" id="idUseAutoCorrTime" onchange = "UseAutoCorrTime()"/>
                <label for="idUseAutoCorrTime">Auto corr time</label><BR>


                <HR>
            </DIV>
        </DIV>

        <DIV id="idCurrentBlockNum" style="float: left"></DIV>

        <DIV id="wallet_config_tab" style="display: none;float: left">
            Wallet data path: <B id="idDataPath"></B><BR>
            Public key: <B id="idPubKey"></B><BR>
            Node addr: <B id="idNodeAddr"></B>
            <BR>


            <INPUT type="button" onclick="NewPrivateKey();" class="btdoit bt" value="New wallet..." id="idDown2">
            <INPUT type="button" onclick="EditPrivateKey();SetImg(this,'edit_keys');" class="btdoit bt" value="Edit wallet" id="idDown">
            <INPUT type="button" onclick="ViewNewAccount();SetImg(this,'edit_create_acc');" class="btdoit bt" value="New account" id="idDown">
            <INPUT type="button" onclick="MiningSets();SetImg(this,'edit_mining_set');" class="btdoit bt" value="Set mining" id="idDown">
            <INPUT type="button" onclick="ViewSetPassword();itemBtPassword=this; SetImg(itemBtPassword,'idBlockPassword');" class="bt btdoit" value="Set password" id="idDown">

        </DIV>


        <DIV id="edit_mining_set" style="display: none">
            <table class="form_input keys" id="grid_mining_set">
                <tr>
                    <td><DIV>Mining account:</DIV></td><td><INPUT type="number" id="idMiningAccount" min=0 max=1000000000000 value="0"></td>
                </tr>

                <tr>
                    <td></td>
                    <td><INPUT type="button" onclick="SaveMiningSet()" class="bt" value="Save">
                        <INPUT type="button" onclick="CancalMiningSet()" class="bt" value="Cancel"></td>
                </tr>
            </table>
        </DIV>


        <DIV id="edit_keys" style="display: none">
            <table class="form_input keys" id="grid_edit_key">
                <tr>
                    <td>
                        <select size="1" id="idTypeKey" onkeyup="SelectTypeKey();" onchange="SelectTypeKey();">
                            <option value="private">Private key</option>
                            <option value="public">Public key (sign from another wallet)</option>
                            <option value="brain">Brain key generator</option>
                        </select>
                    </td><td><INPUT type="string" autocomplete="off" id="idKeyNew" value=""></td>
                </tr>
                <tr id="idViewKeyNew2" style="display: none">
                    <td>You can repeat the secret words:</td>
                    <td><INPUT type="string" id="idKeyNew2" value=""></td>
                </tr>

                <tr>
                    <td></td>
                    <td>
                        <INPUT type="button" onclick="ConvertToPrivateKey()" class="btdoit bt" style="width: 130px;display: none;" id="idBtConvertKey" value="Convert to key">
                        <INPUT type="button" onclick="SavePrivateKey()" class="bt" id="idBtSaveKey" value="Save">
                        <INPUT type="button" onclick="CancelSavePrivateKey()" class="bt" value="Cancel">
                    </td>
                </tr>
            </table>
        </DIV>




        <DIV id="edit_create_acc" style="display: none">
            <table class="form_input keys" id="grid_edit_newacc">
                <tr>
                    <td><DIV>Public name:</DIV></td>
                    <td>
                        <INPUT type="string" maxlength="40" autocomplete="off" id="idAccDescription" onkeyup="CheckLengthAccDesription('idAccDescription',40)" value="">
                    </td>
                </tr>
                <tr>
                    <td>
                        <DIV>Adviser:</DIV></td><td><INPUT type="number" id="idAdviser" min=0 max=1000000000000 value="0">
                    </td>
                </tr>

                <tr>
                    <td>
                        <DIV>Currency:</DIV></td><td><INPUT type="number" id="idCurrency" min=0 max=1000000000 value="0">
                </td>
                </tr>
                <tr>
                    <td>
                        <DIV>Smart:</DIV></td><td><INPUT type="number" id="idSmart" min=0 max=1000000000 value="0">
                    </td>
                </tr>
                <!--<tr>-->
                    <!--<td></td><td><INPUT type="checkbox" checked id="idAutoSetMining">Mining on this account</td>-->
                <!--</tr>-->

                <tr id="idRowWN" style="display: none">
                    <td>
                        <DIV>Wallet number:</DIV></td><td><INPUT type="number" id="idWN" min=0 max=100 value="0">
                 </td>
                </tr>

                <tr>
                    <td></td>
                    <td><INPUT type="button" onclick="CreateAccount(0)" class="bt" value="Create">
                        <INPUT type="button" onclick="CancelCreateAccount()" class="bt" value="Cancel">
                        <INPUT type="button" onclick="CreateAccount(1)" class="bt btdoit" style="width: 130px;" id="idBtRun" value="Add to Pay list">
                    </td>
                </tr>

            </table>
        </DIV>


        <BR>
        <table id="grid_accounts" class="grid">
            <tr>
                <th id="Item.Num" class="num">ID</th>
                <th id="SUM_TO_STRING(Item.Value)" class="sum bold">Amount</th>
                <th id="CurrencyNameItem(Item)" class="cur">Cur</th>
                <th id="Item.Name" class="accname">Account name</th>
                <th id="Item.Value.OperationID" class="num">Operation</th>
                <th id="Item.Adviser" class="num">Adviser</th>
                <th id="(RetChangeSmart(Item))" class="smart">Smart</th>
                <th id="Item.WN" class="num" style="width: 30px;"></th>
            </tr>
        </table>

        <B><DIV id="idMyTotalSum"></DIV></B>


        <INPUT type="button" id="idDown" onclick="ViewNetworkMode();SetImg(this,'idNetworkView')"
               class="btdoit bt" value="NET CONNECT">
        <INPUT type="button" id="idDown" onclick="ViewRemoteParams();SetImg(this,'idRemoteView')"
               class="btdoit bt" value="HTTP ACCESS">
        <INPUT type="button" id="idDown" onclick="ViewConstant();SetImg(this,'idConstantView')"
               class="btdoit bt" value="CONSTANTS">
        <INPUT type="button" onclick="FindMyAccounts();" class="btdoit bt" value="Refresh accounts">


        <DIV id="idNetworkView" style="display: none">
            <H3>Network connections:</H3>
            <INPUT type="checkbox" id="idUseDirectIP">Run server and use direct IPv4 address on this computer (recommended):<BR>
            IP:<INPUT  maxlength="16" id="idIP"> Port:<INPUT maxlength="9" id="idPort"><BR>
            <!--<INPUT type="checkbox" id="idUseIncomeGrayIP">Allow connection users without a direct ip:<BR>-->
            <!--White list nodes (HEX-format):<BR>-->
            <TEXTAREA id="idNodeWhiteList" rows="4" cols="100" style="display: none"> </TEXTAREA>
            <BR>

            <INPUT type="button" onclick="SetNetworkParams(0)" class="btdoit bt" value="Save">
            <INPUT type="button" onclick="SetNetworkParams(1)" class="btdoit bt" value="Save and Restart">
            <HR>
        </DIV>

        <DIV id="idRemoteView" style="display: none">
            <H3>Remote access:</H3>

            <table class="form_input keys">
                <tr>
                    <td>HTTP port:</td>
                    <td><INPUT type="string" id="idHTTPPort" maxlength="6" value="80"></td>
                </tr>
                <tr>
                    <td>Password on HTTP:</td>
                    <td><INPUT type="string" id="idHTTPPassword"></td>
                </tr>
            </table>
            <BR>
            <INPUT type="button" onclick="SetRemoteParams(0)" class="btdoit bt" value="Save">
            <INPUT type="button" onclick="SetRemoteParams(1)" class="btdoit bt" value="Save and Restart">
            <HR>
        </DIV>

        <DIV id="idConstantView" style="display: none">
            <H3>All constants (only for advanced users):</H3>
            <TEXTAREA id="idConstant" rows="20" cols="110"> </TEXTAREA><BR>
            <BR>
            <INPUT type="button" onclick="SaveConstant(0)" class="btdoit bt" value="Save">
            <INPUT type="button" onclick="SaveConstant(1)" class="btdoit bt" value="Save and Restart">
            <HR>
        </DIV>


        Style:
        <select size="1" id="idSelStyle" onkeyup="SelectStyle();SaveValues()" onchange="SelectStyle();SaveValues()">
            <option value="styleBrown">Brown</option>
            <option value="styleBlue">Blue</option>
            <option value="styleGreen">Green</option>
        </select>



    </DIV>


    <DIV id="TabHistory" style="display: none">
        <DIV id="idPaginationHistory" style="display: none">
            Search:<INPUT type="search" id="idViewHistoryFilter" value="" onchange="ViewCurrent(DefHistory)">
            <INPUT type="button" onclick="ViewBegin(DefHistory)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefHistory)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewHistoryNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefHistory)">
            <INPUT type="button" onclick="ViewNext(DefHistory,HistoryMaxNum)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefHistory,HistoryMaxNum)" class="btdoitm bt" value="->|">
        </DIV>

        <table id="grid_history" class="grid">
            <tr>
                <th id="(RetDirect(Item.Direct))" class="direct">Direct</th>
                <th id="ConfirmationFromBlock(Item.BlockNum)" class="txt">Confirm</th>
                <th id="(escapeHtml(DateFromBlock(Item.BlockNum)))" class="date">Date</th>
                <th id="SUM_TO_STRING(Item)" class="sum smallbold">Amount</th>
                <th id="CurrencyName(Item.Currency)" class="cur">Cur</th>
                <th id="Item.Description"class="desc">Description</th>
                <th id="Item.FromID" class="num">From</th>
                <th id="(GetStrID(Item.ToID,Item.ToName))" class="txt">To</th>
                <th id="Item.FromOperationID">Operation</th>
                <th id="(RetOpenBlock(Item.BlockNum,1))" class="num">Block</th>
            </tr>
        </table>
        <B><DIV id="idTotalSumH"></DIV></B>

        <INPUT type="checkbox" onchange = "SaveValues()" id="idUseSoundHistory">Use sound on receive coins<BR>

        <script>
            //ACCOUNT ID
            function GetStrID(num,name)
            {
                if(num===1000000000000)
                    num="<B></B>";
                if(name)
                    return ""+num+"&nbsp;<B>"+escapeHtml(name)+"</B>";
                else
                    return "<B>"+num+"</B>";
            }
        </script>
    </DIV>




    <DIV id="TabSend" style="display: none">

        <DIV id="idSendList"> </DIV>
        <table class="form_input">
            <tr>
                <td style="min-width: 115px">From account</td>
                <td>

                    <select size="1" id="idAccount" onkeyup="OnEditTransactionFields()" onchange="OnEditTransactionFields()">
                    </select>

                </td>
            </tr>
            <tr><td>&nbsp;</td><td><DIV id="idNameTo" class="smallbold"></DIV></td></tr>
            <tr>
                <td>Pay to</td>
                <td>
                    <INPUT style="float: left" type="string" id="idTo" value="" onkeyup="OnEditIdTo()" onchange="OnEditIdTo()"placeholder="Payee (required)" >
                </td>
            </tr>
            <tr>
                <td>Amount</td>
                <td>
                    <INPUT type="number" id="idSumSend" value="" step=0 min=0 max=1000000000 onkeyup="OnEditTransactionFields()" onchange="OnEditTransactionFields()">&nbsp;<B id="idCoinName"></B>
                </td>
            </tr>
            <tr>
                <td>Description (optional)</td><td><textarea id="idDescription" rows="4" onkeyup="CheckLengthAccDesription('idDescription',200);OnEditTransactionFields()" onchange="OnEditTransactionFields()"></textarea></td>
                <td><DIV id="idAttach"> </DIV></td>
            </tr>
            <tr>
                <td>
                </td>
                <td>
                    <INPUT type="button" onclick="ClearTransaction()" class="bsend bt" value="Clear">
                    <INPUT type="button" onclick="EditJSONTransaction();SetImg(this,'edit_transaction');" class="bsend bt" value="Edit JSON" id="idDown">
                    <INPUT type="button" onclick="SendMoney()" class="bsend bt" id="idSendButton" value="Send" >
                </td>
            </tr>
        </table>
        <DIV id="edit_transaction" style="display: none">
            <textarea id="idTransaction" rows="20" onkeyup="StartEditTransactionJSON()" onchange="StartEditTransactionJSON()"></textarea>
            <BR>
            <INPUT type="button" onclick="SignJSON()" class="btdoit bt" value="Sign JSON" id="idSignJSON">
            <INPUT type="button" onclick="SendMoneyJSON()" class="btdoit bt" value="Send from JSON">
        </DIV>



    </DIV>


    <DIV id="TabDapps" style="display: none">


        <script>
            //dapps

            var glNumPayCount=0;
            function GetInvoiceHTML(item,onclick,classstr)
            {
                if(!item.num)
                {
                    glNumPayCount++;
                    item.num=glNumPayCount;
                }
                var idname="idSendInvoice"+item.num;
                var value="";
                if(item.Data.Amount)
                    value+="<B>"+item.Data.Amount+"</B> Tera";
                else
                    value+="<B style='color:green'>No pay</B>";

                value+="&#x00A;"+item.num+". "+item.Data.name;
                return "<button id='"+idname+"' onclick='"+onclick+"' class='"+classstr+"'>"+value+"</button>";
            }

            function AddSendList(item)
            {
                PayList.push({Data:item});
            }

            function CheckSendList(bRedraw)
            {
                TitleWarning=PayList.length;
                if(AttachItem)
                    TitleWarning++;

                var Str=localStorage["InvoiceList"];
                if(!Str && !bRedraw)
                    return;

                if(!bRedraw)
                {
                    SelectTab("TabSend");
                }

                if(Str)
                {
                    var arr=JSON.parse(Str)
                    for(var i=0;i<arr.length;i++)
                    {
                        AddSendList(arr[i])
                    }
                    localStorage["InvoiceList"]="";
                }


                var idList=$("idSendList");
                if(PayList.length)
                {
                    idList.innerHTML="<DIV id='PaiListInfo'>Select the item you want to sign (pay) and send to blockchain:</DIV>";
                    for(var i=0;i<PayList.length;i++)
                    {
                        var item=PayList[i];
                        idList.innerHTML+=GetInvoiceHTML(item,"UseInvoice("+i+")","btinvoice");
                    }

                    if(AttachItem===undefined)
                        UseInvoice(0);
                }
                else
                {
                    idList.innerHTML="";
                }
            }
            setInterval(CheckSendList,200);

            function UseInvoice(Num)
            {
                var item=PayList[Num];
                if(item.Data.From)
                    $("idAccount").value=item.Data.From;

                $("idTo").value=item.Data.To;
                $("idSumSend").value=item.Data.Amount;
                $("idDescription").value=item.Data.Description;

                PayList.splice(Num,1);

                AttachItem=item;
                $("idAttach").innerHTML=GetInvoiceHTML(AttachItem,"OpenAttach()","btinvoice btinvoice_use");

                CheckSendList(1);
            }

            function ClearAttach()
            {
                AttachItem=undefined;
                $("idAttach").innerHTML="";
            }

            function OpenAttach()
            {
                if(AttachItem)
                {
                    var Data2=JSON.parse(JSON.stringify(AttachItem.Data));
                    if(Data2.Body)
                        Data2.Body=GetHexFromArr(Data2.Body);
                    delete Data2.TransferSecret;
                    alert("DATA:\n"+JSON.stringify(Data2,"",4));
                }
            }



        </script>

        <INPUT type="button" onclick="window.Open('./HTML/dapp-edit.html','smart',1240)" class="btdoit btopen bt" id="idOpenSmart" value="*New dapp">


        <BR>
        <DIV id="idPaginationDapps" style="display: block">
            <!--<DIV id="view_header" >DAPPS</DIV><BR>-->
            Search:<INPUT type="search" id="idViewDappsFilter" value="" onchange="ViewCurrent(DefDapps)">
            Category:
            <select size="1" id="idCategory" onchange="ViewCurrent(DefDapps)">
            </select>
            <BR>

            <INPUT type="button" onclick="ViewBegin(DefDapps)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefDapps)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewDappNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefDapps)">
            <INPUT type="button" onclick="ViewNext(DefDapps,MaxDappsID)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefDapps,MaxDappsID)" class="btdoitm bt" value="->|">

            <table id="grid_dapps_all" class="grid">
                <tr>
                    <th id="(RetNumDapp(Item))" class="num">ID</th>
                    <th id="(RetOpenDapps(Item))" class="accname">Name</th>
                    <th id="Item.Description" class="code">Description</th>
                    <th id="(RetCategory(Item))" class="">Category</th>

                    <th id="RetBaseAccount(Item)" class="num">Base Account</th>
                    <th id="Item.Owner" class="num">Owner</th>
                    <th id="RetBool(Item.TokenGenerate)" class="bool">Token generate</th>
                    <th id="Item.ISIN" class="num">ISIN</th>
                    <th id="(RetOpenBlock(Item.BlockNum,1))" class="num">Block Num</th>

                </tr>
            </table>


            <INPUT type="button" onclick="ViewPrev(DefDapps)" class="btdoit bt" value="<< Prev">
            <INPUT type="button" onclick="ViewNext(DefDapps,MaxDappsID)" class="btdoit bt" value="Next >>">

        </DIV>

        <!--<BR>-->
        <!--<iframe src="test.html" name="dapp" width="795" height="400" sandbox="allow-scripts"> </iframe>-->

    </DIV>


    <DIV id="TabExplorer" style="display: none">

        <INPUT type="button" onclick="window.Open('./HTML/stat.html','counters',920)" class="btdoit btopen bt" id="idCounters" value="Counters">
        <INPUT type="button" onclick="window.Open('./HTML/chains.html','chains',1240,600)" class="btdoit btopen bt" id="idChains" value="Chains">
        <INPUT type="button" onclick="window.Open('./HTML/console.html','console',1240)" class="btdoit btopen bt" id="idConsole" value="Console">
        <INPUT type="button" onclick="window.Open('./HTML/monitor.html','monitor',1200)" class="btdoit btopen bt" id="idMonitor" value="Monitor">

        <INPUT type="button" onclick="window.Open('./HTML/network.html','network',1200)" class="btdoit btopen bt" id="idNetwork" value="Network">


        <BR>
        <INPUT type="button" onclick="ViewCurrent(DefAccounts,1,this);" class="btdoit bt btexlporer" id="idDown" value="Accounts">
        <INPUT type="button" onclick="ViewCurrent(DefBlock,1,this)" class="btdoit bt btexlporer" id="idDown" value="Blocks & Tr">
        <INPUT type="button" onclick="ViewCurrent(DefActs,1,this)" class="btdoit bt btexlporer" id="idDown" value="Accounts acts">
        <INPUT type="button" onclick="ViewCurrent(DefHash,1,this)" class="btdoit bt btexlporer" id="idDown" value="Accounts hash">
        <INPUT type="button" onclick="SetVisibleBlock('idUtilView',!IsVisibleBlock('idUtilView'));SetImg(this,'idUtilView');" class="btdoit bt btexlporer" id="idDown" value="Utilites">


        <BR>
        <DIV id="idPaginationAccount" style="display: none">
            <HR>
            <DIV id="view_header" >Accounts</DIV><BR>
            JS:<INPUT type="search" id="idViewAccountFilter" value="" onchange="ViewCurrent(DefAccounts)">
            <INPUT type="button" onclick="ViewBegin(DefAccounts)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefAccounts)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewAccountNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefAccounts)">
            <INPUT type="button" onclick="ViewNext(DefAccounts,MaxAccID)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefAccounts,MaxAccID)" class="btdoitm bt" value="->|">

            <table id="grid_accounts_all" class="grid">
                <tr>
                    <th id="Item.Num" class="num">ID</th>
                    <th id="SUM_TO_STRING(Item.Value)" class="sum smallbold">Amount</th>
                    <th id="CurrencyNameItem(Item)" class="cur">Cur</th>
                    <th id="Item.Name" class="accname">Name</th>
                    <th id="Item.PubKeyStr" class="pubkey">PubKey</th>
                    <th id="Item.Value.OperationID" class="num">Operation</th>
                    <th id="Item.Adviser" class="num">Adviser</th>
                    <th id="Item.Value.Smart" class="num">Smart</th>
                    <th id="(RetOpenBlock(Item.BlockNumCreate,1))" class="num">Block Num</th>
                </tr>
            </table>

            <INPUT type="button" onclick="ViewPrev(DefAccounts)" class="btdoit bt" value="<< Prev">
            <INPUT type="button" onclick="ViewNext(DefAccounts,MaxAccID)" class="btdoit bt" value="Next >>">

        <BR>
        <B><DIV id="idTotalSum"></DIV></B>
        <BR>
        </DIV>

        <DIV id="idPaginationBlock" style="display: none">
            <HR>
            <DIV id="view_header" >Blocks<BR></DIV>
            <!--<DIV id="idFilterB">JS:<INPUT type="search" id="idViewBlockFilter"  value="" onchange="ViewCurrent(DefBlock)"></DIV>-->
            <INPUT type="button" onclick="ViewBegin(DefBlock)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefBlock)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewBlockNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefBlock)">
            <INPUT type="button" onclick="ViewNext(DefBlock,ServerBlockNumDB)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefBlock,ServerBlockNumDB)" class="btdoitm bt" value="->|">

            <table id="grid_block_all" class="grid">
                <tr>
                    <th id="(RetOpenBlock(Item.BlockNum,Item.TrDataLen))" class="hash">Num</th>
                    <th id="(escapeHtml(DateFromBlock(Item.BlockNum)))" class="date">Date</th>
                    <th id="GetHexFromArr(Item.TreeHash)" class="hash">Data Hash</th>
                    <!--<th id="GetHexFromArr(Item.AddrHash)" class="hash">AddrHash</th>-->
                    <th id="GetHexFromArr(Item.PowHash)" class="hash">PowHash</th>
                    <th id="GetHexFromArr(Item.Hash)" class="hash">Block Hash</th>

                    <!--<th id="ReadUintFromArr(Item.AddrHash,6)" class="hash">Nonce0</th>-->
                    <!--<th id="ReadUintFromArr(Item.AddrHash,12)" class="hash">Nonce1</th>-->
                    <!--<th id="ReadUintFromArr(Item.AddrHash,18)" class="hash">Nonce2</th>-->

                    <th id="Item.TrDataLen" class="hash">Bytes</th>
                    <th id="Item.Power" class="num">Pow</th>
                    <th id="GetPowPower(Item.Hash1)" class="num">Pow1</th>
                    <th id="GetPowPower(Item.Hash2)" class="num">Pow2</th>

                    <th id="Item.Miner" class="hash">Miner</th>
                </tr>
            </table>

            <INPUT type="button" onclick="ViewPrev(DefBlock)" class="btdoit bt" value="<< Prev">
            <INPUT type="button" onclick="ViewNext(DefBlock,ServerBlockNumDB)" class="btdoit bt" value="Next >>">

        </DIV>


        <DIV id="idPaginationAct" style="display: none">
            <HR>
            <DIV id="view_header" >Accounts acts<BR></DIV>
            <INPUT type="button" onclick="ViewBegin(DefActs)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefActs)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewActNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefActs)">
            <INPUT type="button" onclick="ViewNext(DefActs,MaxActNum)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefActs,MaxActNum)" class="btdoitm bt" value="->|">


            <table id="grid_acts_all" class="grid">
                <tr>
                    <th id="Item.Num" class="num">Num</th>
                    <th id="Item.ID" class="num">Account</th>
                    <th id="Item.Mode">Mode</th>
                    <th id="(RetOpenBlock(Item.BlockNum,1))" class="num">Block</th>
                    <th id="Item.TrNum" class="num">TrNum</th>
                    <th id="(escapeHtml(DateFromBlock(Item.BlockNum)))" class="date">Date</th>

                    <th id="Item.PrevValue.OperationID" class="num">Prev. Operation</th>
                    <th id="SUM_TO_STRING(Item.PrevValue)" class="sum">Prev. amount</th>
                </tr>
            </table>
            <INPUT type="button" onclick="ViewPrev(DefActs)" class="btdoit bt" value="<< Prev">
            <INPUT type="button" onclick="ViewNext(DefActs,MaxActNum)" class="btdoit bt" value="Next >>">

        </DIV>

        <DIV id="idPaginationHash" style="display: none">
            <HR>
            <DIV id="view_header" >Accounts hash<BR></DIV>
            <INPUT type="button" onclick="ViewBegin(DefHash)" class="btdoitm bt" value="|<-">
            <INPUT type="button" onclick="ViewPrev(DefHash)" class="btdoit bt" value="<< Prev">
            <INPUT type="number" id="idViewHashNum" style="text-align: center" value="0" min=0 max=1000000000 onchange="ViewCurrent(DefHash)">
            <INPUT type="button" onclick="ViewNext(DefHash,ServerBlockNumDB)" class="btdoit bt" value="Next >>">
            <INPUT type="button" onclick="ViewEnd(DefHash,ServerBlockNumDB)" class="btdoitm bt" value="->|">

            <table id="grid_hash_all" class="grid">
                <tr>
                    <th id="(RetOpenBlock(Item.BlockNum,Item.TrDataLen))" class="num">Block</th>
                    <th id="(escapeHtml(DateFromBlock(Item.BlockNum)))" class="date">Date</th>
                    <th id="GetHexFromArr(Item.Hash)" class="code">Hash</th>
                </tr>
            </table>
            <INPUT type="button" onclick="ViewPrev(DefHash)" class="btdoit bt" value="<< Prev">
            <INPUT type="button" onclick="ViewNext(DefHash,ServerBlockNumDB)" class="btdoit bt" value="Next >>">
        </DIV>

        <DIV id="idUtilView" style="display: none">
            <HR>
            <DIV id="view_header" >UTILITES<BR></DIV>

            Number of blocks in depth:<INPUT type="number" id="idBlockCount" onchange = "SaveValues()" value="0"><BR>
            <INPUT type="button" onclick="RestartNode()"  class="bt btdoit btlong" value="Restart node">
            <INPUT type="button" onclick="RewriteTransactions()"  class="bt btdoit btlong" value="Rewrite transactions">
            <INPUT type="button" onclick="TruncateBlockChain()" class="btdoit btlong bt" value="Truncate chain">
            <INPUT type="button" onclick="ClearDataBase()" class="btdoit btlong bt" value="Clear DataBase <!>">




            <DIV id="idDevelopService2">
            <INPUT type="button" onclick="CleanChain()"  class="bt btdoit btlong" value="Clean chain">
                <BR>
                <textarea id="idRunText" rows="8" cols="98" autofocus></textarea>
                <BR>
                <INPUT type="button" onclick="SetRun()"  class="bt btdoit" value="Set run">
            </DIV>

            <BR>

        </DIV>

    </DIV>



    <BR>
    <DIV id="idServerBlock" style="width: 99.5%">
        <HR>
        Log from node:
        <DIV id="idServerLog"></DIV><BR>
    </DIV>


    <DIV id="idBlockPassword" style="display: none">
        <H3 align="center">Enter your password:</H3>
        <table class="password" id="idTablePassword">
            <tr style="display: none">
                <td><DIV>Login:</DIV></td><td><INPUT type="string"  id="Login" value=""></td>
            </tr>
            <tr>
                <td><DIV>Password:</DIV></td><td><INPUT type="password"  id="idPassword1" value=""></td>
            </tr>

            <tr id="idPasswordRow2" style="display: none">
                <td><DIV>Repeat:</DIV></td><td><INPUT type="password"  id="idPassword2" onkeyup="" value=""></td>
            </tr>

            <tr>
                <td></td>
                <td><INPUT type="button" onclick="SetPassword()" class="bt" value="Set">
                    <INPUT type="button" onclick="CancelSetPassword()" class="bt" value="Cancel"></td>
            </tr>

        </table>
    </DIV>



    <DIV id="idStableScroll" align='center'>
        <A href="https://bitcointalk.org/index.php?topic=4573801.0">ANN</A>
        <A href="https://twitter.com/terafoundation">Twitter</A>
        <A href="https://web.telegram.org/#/im?p=@terafoundation">Telegram</A>
        <A href="https://discord.gg/CvwrbeG">Discord</A>
        <!--progr76@gmail.com-->
    </DIV>


    <audio style="visibility: hidden;" controls="controls" id="sound_coin">
        <source src="coin.mp3" type="audio/mpeg"/>
    </audio>
    <audio style="visibility: hidden;" controls="controls" id="sound_err">
        <source src="click.mp3" type="audio/mpeg"/>
    </audio>

</DIV>
</DIV>
</body>
</html>
